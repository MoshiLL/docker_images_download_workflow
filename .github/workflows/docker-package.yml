name: Docker Image Package Builder

on:
  workflow_dispatch:
    inputs:
      image_name:
        description: 'Docker镜像名称（格式：repository/image:tag）'
        required: true
        default: 'nginx:latest'
      release_tag:
        description: 'Release标签（格式：v1.0.0）'
        required: true
        default: 'v'
      split_size:
        description: '分片大小（单位：G，建议2G）'
        required: true
        default: '2'

jobs:
  package-image:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Clean up disk space
        run: |
          echo "清理磁盘空间..."
          # 清理apt缓存
          sudo apt-get clean
          # 删除无用的包
          sudo apt-get autoremove --purge -y
          # 清理旧的内核
          sudo apt-get remove --purge -y $(dpkg -l | grep 'linux-image-.*-generic' | awk '{print $2}' | grep -v $(uname -r))
          # 清理docker缓存
          docker system prune -a -f --volumes
          # 清理临时文件
          rm -rf /tmp/*
          rm -rf ~/*
          
          echo "清理后磁盘空间:"
          df -h
          echo "可用inode:"
          df -i

      - name: Set up Docker
        uses: docker/setup-buildx-action@v2

      - name: Pull Docker image
        run: |
          echo "正在下载镜像: ${{ github.event.inputs.image_name }}"
          # 先清理docker系统
          docker system prune -f
          
          # 拉取镜像
          docker pull ${{ github.event.inputs.image_name }}
          
          echo "镜像信息:"
          docker images
          
          echo "系统状态:"
          df -h /var/lib/docker

      - name: Save and split image
        run: |
          IMAGE_NAME="${{ github.event.inputs.image_name }}"
          SPLIT_SIZE="${{ github.event.inputs.split_size }}G"
          
          echo "开始保存镜像到临时位置..."
          # 使用/tmp目录，通常有更多空间
          DOCKER_IMAGE_PATH="/tmp/image.tar"
          
          # 保存镜像
          docker save "$IMAGE_NAME" -o "$DOCKER_IMAGE_PATH"
          
          echo "镜像保存完成，文件大小: $(du -h "$DOCKER_IMAGE_PATH")"
          
          # 检查空间
          echo "保存后磁盘空间:"
          df -h /tmp
          
          # 分割文件
          echo "开始分割文件，每片 $SPLIT_SIZE..."
          cd /tmp
          split -b "$SPLIT_SIZE" -d --additional-suffix=.part "image.tar" "image.tar.part"
          
          # 生成校验和
          echo "生成校验和..."
          sha256sum image.tar.part* > checksums.txt
          sha256sum image.tar >> checksums.txt
          
          # 获取分片数量
          PART_COUNT=$(ls image.tar.part* 2>/dev/null | wc -l)
          echo "分片数量: $PART_COUNT"
          
          # 创建说明文件
          echo "Docker Image Package" > README.txt
          echo "=====================" >> README.txt
          echo "" >> README.txt
          echo "原始镜像: $IMAGE_NAME" >> README.txt
          echo "分片大小: $SPLIT_SIZE" >> README.txt
          echo "分片数量: $PART_COUNT" >> README.txt
          echo "完整文件大小: $(du -h image.tar | cut -f1)" >> README.txt
          
          # 移动文件到工作目录
          echo "移动文件到工作目录..."
          mv image.tar.part* checksums.txt README.txt $GITHUB_WORKSPACE/
          
          # 清理/tmp
          rm -f /tmp/image.tar
          echo "清理完成"

      - name: Create ZIP package
        run: |
          echo "创建ZIP包..."
          mkdir windows_package
          cp image.tar.part* checksums.txt README.txt windows_package/
          zip -r docker_image_package.zip windows_package/
          rm -rf windows_package
          
          echo "ZIP包大小: $(du -h docker_image_package.zip)"

      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            docker_image_package.zip
            checksums.txt
            README.txt
          tag_name: ${{ github.event.inputs.release_tag }}${{ github.run_number }}
          name: Docker Image Package ${{ github.event.inputs.image_name }} (${{ github.event.inputs.release_tag }}${{ github.run_number }})
          body: |
            **Docker镜像包信息**
            - 镜像名称: ${{ github.event.inputs.image_name }}
            - 分片大小: ${{ github.event.inputs.split_size }}GB
            - 分片数量: $(ls image.tar.part* 2>/dev/null | wc -l)
            - 完整文件大小: $(du -h image.tar 2>/dev/null | cut -f1 || echo "N/A")
            - 生成时间: $(date '+%Y-%m-%d %H:%M:%S')
            
            **注意**: 由于GitHub Actions存储空间限制，大型镜像建议使用较小的分片大小或考虑其他方案。

      - name: Cleanup
        if: always()
        run: |
          echo "最终清理..."
          rm -f docker_image_package.zip
          rm -f image.tar.part*
          rm -f checksums.txt
          rm -f README.txt
          docker system prune -a -f --volumes
          echo "清理完成"
