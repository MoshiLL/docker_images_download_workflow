name: Docker Image Package Builder

on:
  workflow_dispatch:
    inputs:
      image_name:
        description: 'Docker镜像名称（格式：repository/image:tag）'
        required: true
        default: 'nginx:latest'
      release_tag:
        description: 'Release标签（格式：v1.0.0）'
        required: true
        default: 'v$(date +%Y%m%d)'
      split_size:
        description: '分片大小（单位：G，建议2G）'
        required: true
        default: '2'

jobs:
  package-image:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker
        uses: docker/setup-buildx-action@v2

      - name: Pull Docker image
        run: |
          echo "正在下载镜像: ${{ github.event.inputs.image_name }}"
          docker pull ${{ github.event.inputs.image_name }}
          docker save ${{ github.event.inputs.image_name }} -o image.tar
          echo "镜像下载完成，文件大小: $(du -h image.tar)"

      - name: Split image and generate checksums
        run: |
          # 获取分片大小
          SPLIT_SIZE="${{ github.event.inputs.split_size }}G"
          echo "分片大小: $SPLIT_SIZE"
          
          # 按指定大小分割文件
          echo "开始分割文件..."
          split -b "$SPLIT_SIZE" -d --additional-suffix=.part image.tar image.tar.part
          
          # 生成分片校验和
          echo "生成分片校验和..."
          sha256sum image.tar.part* > checksums.txt
          
          # 生成完整文件校验和
          echo "生成完整文件校验和..."
          sha256sum image.tar >> checksums.txt
          
          # 获取分片数量
          PART_COUNT=$(ls image.tar.part* 2>/dev/null | wc -l)
          echo "分片数量: $PART_COUNT"
          
          # 创建说明文件
          cat > README.txt <<EOF
Docker Image Package
=====================

原始镜像: ${{ github.event.inputs.image_name }}
分片大小: $SPLIT_SIZE
分片数量: $PART_COUNT
完整文件大小: $(du -h image.tar | cut -f1)

校验和文件说明:
- 前$PART_COUNT行是各个分片的SHA256校验和
- 最后一行是完整image.tar文件的SHA256校验和

使用步骤:
1. 下载所有文件（image.tar.part*、checksums.txt、README.txt）
2. 将所有文件打包成zip（在Windows上）
3. 上传zip文件到Linux服务器
4. 在Linux服务器上执行以下命令:

# 解压文件
unzip package.zip

# 合并分片
cat image.tar.part* > image.tar

# 验证完整性
sha256sum -c checksums.txt --ignore-missing

# 如果验证通过，加载Docker镜像
docker load -i image.tar

# 清理临时文件
rm image.tar.part* image.tar checksums.txt README.txt

注意:
- 确保所有分片文件都已下载完整
- 合并顺序由文件名数字序号保证（part00, part01, part02...）
- 如果校验失败，请重新下载对应的分片文件
EOF

      - name: Create ZIP package for Windows download
        run: |
          mkdir windows_package
          cp image.tar.part* checksums.txt README.txt windows_package/
          zip -r docker_image_package.zip windows_package/
          rm -rf windows_package

      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            docker_image_package.zip
            image.tar.part*
            checksums.txt
            README.txt
          tag_name: ${{ github.event.inputs.release_tag }}
          name: Docker Image Package ${{ github.event.inputs.image_name }} (${{ github.event.inputs.release_tag }})
          body: |
            **Docker镜像包信息**
            - 镜像名称: ${{ github.event.inputs.image_name }}
            - 分片大小: ${{ github.event.inputs.split_size }}GB
            - 分片数量: $(ls image.tar.part* 2>/dev/null | wc -l)
            - 完整文件大小: $(du -h image.tar | cut -f1)
            - 生成时间: $(date '+%Y-%m-%d %H:%M:%S')
            
            **使用说明**
            1. 下载 `docker_image_package.zip` 文件（包含所有分片，适合Windows下载）
            2. 或者单独下载所有 `image.tar.part*` 分片文件
            3. 按照 `README.txt` 中的说明进行操作
            
            **完整性验证**
            所有文件都包含SHA256校验和，请在使用前验证文件完整性。
