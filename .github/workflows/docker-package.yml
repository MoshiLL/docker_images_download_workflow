name: Docker Image Package Builder

on:
  workflow_dispatch:
    inputs:
      image_name:
        description: 'Docker镜像名称（格式：repository/image:tag）'
        required: true
        default: 'vllm/vllm-openai:nightly'
      release_tag:
        description: 'Release标签（格式：v1.0.0）'
        required: true
        default: 'v'
      split_size:
        description: '分片大小（单位：M，建议1900M以避免2GiB限制）'
        required: true
        default: '1900'

jobs:
  package-image:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Clean up disk space
        run: |
          echo "清理磁盘空间..."
          # 清理apt缓存
          sudo apt-get clean
          # 删除无用的包
          sudo apt-get autoremove --purge -y
          # 清理旧的内核
          sudo apt-get remove --purge -y $(dpkg -l | grep 'linux-image-.*-generic' | awk '{print $2}' | grep -v $(uname -r)) || true
          # 清理docker缓存
          sudo docker system prune -a -f --volumes
          # 清理旧的日志文件
          sudo journalctl --vacuum-time=1s
          
          echo "清理后磁盘空间:"
          df -h
          echo "可用inode:"
          df -i

      - name: Check /mnt permissions
        run: |
          echo "检查/mnt目录权限..."
          ls -la /mnt
          echo "当前用户: $(whoami)"
          echo "用户组: $(groups)"
          
          # 尝试创建测试目录
          echo "尝试创建测试目录..."
          sudo mkdir -p /mnt/test_dir_$$
          sudo chmod 777 /mnt/test_dir_$$
          echo "测试目录创建成功，权限设置完成"
          sudo rm -rf /mnt/test_dir_$$

      - name: Set up Docker
        uses: docker/setup-buildx-action@v2

      - name: Pull Docker image
        run: |
          echo "正在下载镜像: ${{ github.event.inputs.image_name }}"
          # 拉取镜像
          docker pull ${{ github.event.inputs.image_name }}
          
          echo "镜像信息:"
          docker images
          
          echo "Docker系统状态:"
          docker system df

      - name: Configure Docker to use /mnt for temporary files
        run: |
          echo "配置Docker使用/mnt作为临时目录..."
          
          # 创建Docker临时目录
          sudo mkdir -p /mnt/docker_tmp
          sudo chmod 777 /mnt/docker_tmp
          
          # 设置环境变量，强制Docker使用/mnt
          echo "DOCKER_TMPDIR=/mnt/docker_tmp" >> $GITHUB_ENV
          echo "TMPDIR=/mnt/docker_tmp" >> $GITHUB_ENV
          echo "TEMP=/mnt/docker_tmp" >> $GITHUB_ENV
          echo "TMP=/mnt/docker_tmp" >> $GITHUB_ENV
          
          echo "环境变量设置完成:"
          env | grep -E "(DOCKER_TMPDIR|TMPDIR|TEMP|TMP)"
          
          # 验证目录权限
          ls -la /mnt/docker_tmp

      - name: Save and split image on /mnt with sudo
        run: |
          IMAGE_NAME="${{ github.event.inputs.image_name }}"
          SPLIT_SIZE="${{ github.event.inputs.split_size }}M"  # 使用MB单位，避免GiB限制
          
          echo "检查/mnt分区空间..."
          df -h /mnt
          
          echo "创建专用工作目录在/mnt（使用sudo）..."
          WORK_DIR="/mnt/docker_image_package_$$"
          sudo mkdir -p "$WORK_DIR"
          sudo chmod 777 "$WORK_DIR"
          sudo chown -R $USER:$USER "$WORK_DIR"
          
          echo "工作目录权限:"
          ls -la "$WORK_DIR"
          
          echo "开始保存镜像到/mnt（使用Docker临时目录）..."
          # 保存镜像到/mnt分区
          echo "当前环境变量:"
          env | grep -E "(DOCKER_TMPDIR|TMPDIR|TEMP|TMP)"
          
          echo "Docker临时目录空间:"
          df -h /mnt/docker_tmp
          
          # 关键：直接保存到/mnt，避免临时文件问题
          docker save "$IMAGE_NAME" -o "$WORK_DIR/image.tar" || {
            echo "第一次保存失败，尝试使用dd命令分块保存..."
            # 备选方案：分块保存
            docker create --name temp_container "$IMAGE_NAME"
            CID=$(docker ps -a -f name=temp_container --format "{{.ID}}")
            
            echo "创建临时容器: $CID"
            
            # 分块导出
            docker export "$CID" | dd of="$WORK_DIR/image.tar" bs=1M
            docker rm -f "$CID"
          }
          
          echo "镜像保存完成，文件大小: $(du -h "$WORK_DIR/image.tar")"
          
          # 检查/mnt空间
          echo "/mnt分区空间使用情况:"
          df -h /mnt
          
          echo "开始分割文件，每片 $SPLIT_SIZE..."
          cd "$WORK_DIR"
          
          # 分割文件
          split -b "$SPLIT_SIZE" -d --additional-suffix=.part "image.tar" "image.tar.part"
          
          echo "分割完成，分片文件列表:"
          ls -la image.tar.part*
          
          # 生成校验和
          echo "生成校验和..."
          sha256sum image.tar.part* > checksums.txt
          sha256sum image.tar >> checksums.txt
          
          # 获取分片数量
          PART_COUNT=$(ls image.tar.part* 2>/dev/null | wc -l)
          echo "分片数量: $PART_COUNT"
          
          # 创建说明文件
          echo "Docker Image Package" > README.txt
          echo "=====================" >> README.txt
          echo "" >> README.txt
          echo "原始镜像: $IMAGE_NAME" >> README.txt
          echo "分片大小: $SPLIT_SIZE (确保小于2 GiB = 2048M)" >> README.txt
          echo "分片数量: $PART_COUNT" >> README.txt
          echo "完整文件大小: $(du -h image.tar | cut -f1)" >> README.txt
          echo "" >> README.txt
          echo "校验和文件说明:" >> README.txt
          echo "- 前$PART_COUNT行是各个分片的SHA256校验和" >> README.txt
          echo "- 最后一行是完整image.tar文件的SHA256校验和" >> README.txt
          echo "" >> README.txt
          echo "使用步骤:" >> README.txt
          echo "1. 从GitHub release下载所有文件（image.tar.part*、checksums.txt、README.txt）" >> README.txt
          echo "2. 在Windows上将所有下载的文件打包成ZIP压缩包" >> README.txt
          echo "3. 将ZIP压缩包上传到Linux服务器" >> README.txt
          echo "4. 在Linux服务器上执行以下命令:" >> README.txt
          echo "" >> README.txt
          echo "# 解压ZIP文件" >> README.txt
          echo "unzip package.zip" >> README.txt
          echo "" >> README.txt
          echo "# 合并分片文件" >> README.txt
          echo "cat image.tar.part* > image.tar" >> README.txt
          echo "" >> README.txt
          echo "# 验证文件完整性" >> README.txt
          echo "sha256sum -c checksums.txt --ignore-missing" >> README.txt
          echo "" >> README.txt
          echo "# 如果验证通过，加载Docker镜像" >> README.txt
          echo "docker load -i image.tar" >> README.txt
          echo "" >> README.txt
          echo "# 清理临时文件" >> README.txt
          echo "rm image.tar.part* image.tar checksums.txt README.txt" >> README.txt
          echo "" >> README.txt
          echo "注意:" >> README.txt
          echo "- 确保所有分片文件都已下载完整" >> README.txt
          echo "- 合并顺序由文件名数字序号保证（part00, part01, part02...）" >> README.txt
          echo "- 如果校验失败，请重新下载对应的分片文件" >> README.txt
          echo "- GitHub release文件限制为2 GiB，因此分片大小设置为1900M" >> README.txt
          
          # 移动文件到工作目录（使用sudo确保权限）
          echo "移动文件到工作目录..."
          echo "移动分片文件..."
          sudo mv image.tar.part* $GITHUB_WORKSPACE/
          sudo chown $USER:$USER $GITHUB_WORKSPACE/image.tar.part*
          
          echo "移动校验和文件..."
          sudo mv checksums.txt $GITHUB_WORKSPACE/
          sudo chown $USER:$USER $GITHUB_WORKSPACE/checksums.txt
          
          echo "移动说明文件..."
          sudo mv README.txt $GITHUB_WORKSPACE/
          sudo chown $USER:$USER $GITHUB_WORKSPACE/README.txt
          
          echo "工作目录内容:"
          ls -la $GITHUB_WORKSPACE/
          
          # 清理/mnt上的文件
          echo "清理/mnt上的临时文件..."
          sudo rm -f "$WORK_DIR/image.tar"
          
          echo "清理/mnt工作目录..."
          sudo rm -rf "$WORK_DIR"
          sudo rm -rf /mnt/docker_tmp
          
          echo "清理完成"

      - name: Create release with individual files
        uses: softprops/action-gh-release@v1
        with:
          files: |
            image.tar.part*
            checksums.txt
            README.txt
          tag_name: ${{ github.event.inputs.release_tag }}${{ github.run_number }}
          name: Docker Image Package ${{ github.event.inputs.image_name }} (${{ github.event.inputs.release_tag }}${{ github.run_number }})
          body: |
            **Docker镜像包信息**
            - 镜像名称: ${{ github.event.inputs.image_name }}
            - 分片大小: ${{ github.event.inputs.split_size }}M (确保小于2 GiB限制)
            - 分片数量: $(ls image.tar.part* 2>/dev/null | wc -l)
            - 完整文件大小: $(du -h image.tar 2>/dev/null | cut -f1 || echo "N/A")
            - 生成时间: $(date '+%Y-%m-%d %H:%M:%S')

            **重要提示**
            - GitHub release单个文件大小限制为2 GiB (2,147,483,648字节)
            - 为确保安全，分片大小设置为1900M (1,900,000,000字节)
            - 每个分片文件都严格小于2 GiB限制
            - Docker临时文件已配置使用/mnt分区，避免空间不足
            
            **使用说明**
            1. 从release下载所有 `image.tar.part*` 分片文件
            2. 下载 `checksums.txt` 和 `README.txt`
            3. 在Windows上将所有文件打包成ZIP
            4. 上传到Linux服务器并按照README说明操作
            
            **文件列表**
            $(ls -la image.tar.part* 2>/dev/null || echo "分片文件列表不可用")

      - name: Final cleanup
        if: always()
        run: |
          echo "最终清理..."
          # 只清理我们创建的文件
          rm -f image.tar.part* 2>/dev/null || true
          rm -f checksums.txt 2>/dev/null || true
          rm -f README.txt 2>/dev/null || true
          
          # 清理/mnt上的残留文件
          sudo rm -rf /mnt/docker_image_package_* 2>/dev/null || true
          sudo rm -rf /mnt/docker_tmp 2>/dev/null || true
          
          # 清理docker系统
          sudo docker system prune -a -f --volumes
          
          # 再次检查空间
          echo "最终磁盘空间:"
          df -h /mnt
          df -h /
          
          echo "清理完成"
