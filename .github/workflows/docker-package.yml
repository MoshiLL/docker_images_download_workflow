name: Docker Image Package Builder

on:
  workflow_dispatch:
    inputs:
      image_name:
        description: 'Docker镜像名称（格式：repository/image:tag）'
        required: true
        default: 'nginx:latest'
      release_tag:
        description: 'Release标签（格式：v1.0.0）'
        required: true
        default: 'v'
      split_size:
        description: '分片大小（单位：G，建议2G）'
        required: true
        default: '2'

jobs:
  package-image:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Clean up disk space
        run: |
          echo "清理磁盘空间..."
          # 清理apt缓存
          sudo apt-get clean
          # 删除无用的包
          sudo apt-get autoremove --purge -y
          # 清理docker缓存
          sudo docker system prune -a -f --volumes
          # 清理旧的日志文件
          sudo journalctl --vacuum-time=1s
          
          echo "清理后磁盘空间:"
          df -h
          echo "可用inode:"
          df -i

      - name: Set up Docker
        uses: docker/setup-buildx-action@v2

      - name: Pull Docker image
        run: |
          echo "正在下载镜像: ${{ github.event.inputs.image_name }}"
          # 拉取镜像
          docker pull ${{ github.event.inputs.image_name }}
          
          echo "镜像信息:"
          docker images
          
          echo "Docker系统状态:"
          docker system df

      - name: Save and split image
        run: |
          IMAGE_NAME="${{ github.event.inputs.image_name }}"
          SPLIT_SIZE="${{ github.event.inputs.split_size }}G"
          
          echo "创建专用工作目录..."
          WORK_DIR="/tmp/docker_image_package_$$"
          mkdir -p "$WORK_DIR"
          
          echo "开始保存镜像..."
          # 保存镜像到专用目录
          docker save "$IMAGE_NAME" -o "$WORK_DIR/image.tar"
          
          echo "镜像保存完成，文件大小: $(du -h "$WORK_DIR/image.tar")"
          
          # 检查空间
          echo "保存后磁盘空间:"
          df -h /tmp
          
          echo "开始分割文件，每片 $SPLIT_SIZE..."
          cd "$WORK_DIR"
          
          # 分割文件
          split -b "$SPLIT_SIZE" -d --additional-suffix=.part "image.tar" "image.tar.part"
          
          # 生成校验和
          echo "生成校验和..."
          sha256sum image.tar.part* > checksums.txt
          sha256sum image.tar >> checksums.txt
          
          # 获取分片数量
          PART_COUNT=$(ls image.tar.part* 2>/dev/null | wc -l)
          echo "分片数量: $PART_COUNT"
          
          # 创建说明文件
          echo "Docker Image Package" > README.txt
          echo "=====================" >> README.txt
          echo "" >> README.txt
          echo "原始镜像: $IMAGE_NAME" >> README.txt
          echo "分片大小: $SPLIT_SIZE" >> README.txt
          echo "分片数量: $PART_COUNT" >> README.txt
          echo "完整文件大小: $(du -h image.tar | cut -f1)" >> README.txt
          echo "" >> README.txt
          echo "校验和文件说明:" >> README.txt
          echo "- 前$PART_COUNT行是各个分片的SHA256校验和" >> README.txt
          echo "- 最后一行是完整image.tar文件的SHA256校验和" >> README.txt
          echo "" >> README.txt
          echo "使用步骤:" >> README.txt
          echo "1. 下载所有文件（image.tar.part*、checksums.txt、README.txt）" >> README.txt
          echo "2. 将所有文件打包成zip（在Windows上）" >> README.txt
          echo "3. 上传zip文件到Linux服务器" >> README.txt
          echo "4. 在Linux服务器上执行以下命令:" >> README.txt
          echo "" >> README.txt
          echo "# 解压文件" >> README.txt
          echo "unzip package.zip" >> README.txt
          echo "" >> README.txt
          echo "# 合并分片" >> README.txt
          echo "cat image.tar.part* > image.tar" >> README.txt
          echo "" >> README.txt
          echo "# 验证完整性" >> README.txt
          echo "sha256sum -c checksums.txt --ignore-missing" >> README.txt
          echo "" >> README.txt
          echo "# 如果验证通过，加载Docker镜像" >> README.txt
          echo "docker load -i image.tar" >> README.txt
          echo "" >> README.txt
          echo "# 清理临时文件" >> README.txt
          echo "rm image.tar.part* image.tar checksums.txt README.txt" >> README.txt
          echo "" >> README.txt
          echo "注意:" >> README.txt
          echo "- 确保所有分片文件都已下载完整" >> README.txt
          echo "- 合并顺序由文件名数字序号保证（part00, part01, part02...）" >> README.txt
          echo "- 如果校验失败，请重新下载对应的分片文件" >> README.txt
          
          # 移动文件到工作目录
          echo "移动文件到工作目录..."
          mv image.tar.part* checksums.txt README.txt $GITHUB_WORKSPACE/
          
          echo "专用目录内容:"
          ls -la "$WORK_DIR"
          
          # 清理专用目录（使用sudo确保权限）
          echo "清理专用工作目录..."
          sudo rm -rf "$WORK_DIR"
          
          echo "清理完成"

      - name: Create ZIP package
        run: |
          echo "创建ZIP包..."
          ZIP_DIR="windows_package_$$"
          mkdir "$ZIP_DIR"
          cp image.tar.part* checksums.txt README.txt "$ZIP_DIR/"
          zip -r docker_image_package.zip "$ZIP_DIR"
          rm -rf "$ZIP_DIR"
          
          echo "ZIP包大小: $(du -h docker_image_package.zip)"
          
          # 检查ZIP包完整性
          unzip -t docker_image_package.zip

      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            docker_image_package.zip
            checksums.txt
            README.txt
          tag_name: ${{ github.event.inputs.release_tag }}${{ github.run_number }}
          name: Docker Image Package ${{ github.event.inputs.image_name }} (${{ github.event.inputs.release_tag }}${{ github.run_number }})
          body: |
            **Docker镜像包信息**
            - 镜像名称: ${{ github.event.inputs.image_name }}
            - 分片大小: ${{ github.event.inputs.split_size }}GB
            - 分片数量: $(ls image.tar.part* 2>/dev/null | wc -l)
            - 完整文件大小: $(du -h image.tar 2>/dev/null | cut -f1 || echo "N/A")
            - 生成时间: $(date '+%Y-%m-%d %H:%M:%S')
            
            **使用说明**
            1. 下载 `docker_image_package.zip` 文件
            2. 解压后按照 `README.txt` 中的说明进行操作
            
            **完整性验证**
            所有文件都包含SHA256校验和，请在使用前验证文件完整性。

      - name: Final cleanup
        if: always()
        run: |
          echo "最终清理..."
          # 只清理我们创建的文件
          rm -f docker_image_package.zip 2>/dev/null || true
          rm -f image.tar.part* 2>/dev/null || true
          rm -f checksums.txt 2>/dev/null || true
          rm -f README.txt 2>/dev/null || true
          
          # 清理docker系统，使用sudo
          sudo docker system prune -a -f --volumes
          
          # 再次检查空间
          echo "最终磁盘空间:"
          df -h
          
          echo "清理完成"
