name: Docker Image Package Builder

on:
  workflow_dispatch:
    inputs:
      image_name:
        description: 'Dockeré•œåƒåç§°ï¼ˆæ ¼å¼ï¼šrepository/image:tagï¼‰'
        required: true
        default: 'vllm/vllm-openai:nightly'
      release_tag:
        description: 'Releaseæ ‡ç­¾ï¼ˆæ ¼å¼ï¼šv1.0.0ï¼‰'
        required: true
        default: 'v'
      split_size:
        description: 'åˆ†ç‰‡å¤§å°ï¼ˆå•ä½ï¼šMï¼Œå»ºè®®1900Mä»¥é¿å…2GiBé™åˆ¶ï¼‰'
        required: true
        default: '1900'

jobs:
  package-image:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Clean up disk space
        run: |
          echo "æ¸…ç†ç£ç›˜ç©ºé—´..."
          # æ¸…ç†aptç¼“å­˜
          sudo apt-get clean
          # åˆ é™¤æ— ç”¨çš„åŒ…
          sudo apt-get autoremove --purge -y
          # æ¸…ç†æ—§çš„å†…æ ¸
          sudo apt-get remove --purge -y $(dpkg -l | grep 'linux-image-.*-generic' | awk '{print $2}' | grep -v $(uname -r)) || true
          # æ¸…ç†dockerç¼“å­˜
          sudo docker system prune -a -f --volumes
          # æ¸…ç†æ—§çš„æ—¥å¿—æ–‡ä»¶
          sudo journalctl --vacuum-time=1s
          
          echo "æ¸…ç†åç£ç›˜ç©ºé—´:"
          df -h
          echo "å¯ç”¨inode:"
          df -i

      - name: Check /mnt permissions
        run: |
          echo "æ£€æŸ¥/mntç›®å½•æƒé™..."
          ls -la /mnt
          echo "å½“å‰ç”¨æˆ·: $(whoami)"
          echo "ç”¨æˆ·ç»„: $(groups)"
          
          # å°è¯•åˆ›å»ºæµ‹è¯•ç›®å½•
          echo "å°è¯•åˆ›å»ºæµ‹è¯•ç›®å½•..."
          sudo mkdir -p /mnt/test_dir_$$
          sudo chmod 777 /mnt/test_dir_$$
          echo "æµ‹è¯•ç›®å½•åˆ›å»ºæˆåŠŸï¼Œæƒé™è®¾ç½®å®Œæˆ"
          sudo rm -rf /mnt/test_dir_$$

      - name: Set up Docker
        uses: docker/setup-buildx-action@v2

      - name: Pull Docker image
        run: |
          echo "æ­£åœ¨ä¸‹è½½é•œåƒ: ${{ github.event.inputs.image_name }}"
          # æ‹‰å–é•œåƒ
          docker pull ${{ github.event.inputs.image_name }}
          
          echo "é•œåƒä¿¡æ¯:"
          docker images
          
          echo "Dockerç³»ç»ŸçŠ¶æ€:"
          docker system df

      - name: Configure Docker to use /mnt for temporary files
        run: |
          echo "é…ç½®Dockerä½¿ç”¨/mntä½œä¸ºä¸´æ—¶ç›®å½•..."
          
          # åˆ›å»ºDockerä¸´æ—¶ç›®å½•
          sudo mkdir -p /mnt/docker_tmp
          sudo chmod 777 /mnt/docker_tmp
          
          # è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œå¼ºåˆ¶Dockerä½¿ç”¨/mnt
          echo "DOCKER_TMPDIR=/mnt/docker_tmp" >> $GITHUB_ENV
          echo "TMPDIR=/mnt/docker_tmp" >> $GITHUB_ENV
          echo "TEMP=/mnt/docker_tmp" >> $GITHUB_ENV
          echo "TMP=/mnt/docker_tmp" >> $GITHUB_ENV
          
          echo "ç¯å¢ƒå˜é‡è®¾ç½®å®Œæˆ:"
          env | grep -E "(DOCKER_TMPDIR|TMPDIR|TEMP|TMP)"
          
          # éªŒè¯ç›®å½•æƒé™
          ls -la /mnt/docker_tmp

      - name: Save and split image on /mnt with sudo
        run: |
          IMAGE_NAME="${{ github.event.inputs.image_name }}"
          SPLIT_SIZE="${{ github.event.inputs.split_size }}M"  # ä½¿ç”¨MBå•ä½ï¼Œé¿å…GiBé™åˆ¶
          
          echo "æ£€æŸ¥/mntåˆ†åŒºç©ºé—´..."
          df -h /mnt
          
          echo "åˆ›å»ºä¸“ç”¨å·¥ä½œç›®å½•åœ¨/mntï¼ˆä½¿ç”¨sudoï¼‰..."
          WORK_DIR="/mnt/docker_image_package_$$"
          sudo mkdir -p "$WORK_DIR"
          sudo chmod 777 "$WORK_DIR"
          sudo chown -R $USER:$USER "$WORK_DIR"
          
          echo "å·¥ä½œç›®å½•æƒé™:"
          ls -la "$WORK_DIR"
          
          echo "å¼€å§‹ä¿å­˜é•œåƒåˆ°/mntï¼ˆä½¿ç”¨Dockerä¸´æ—¶ç›®å½•ï¼‰..."
          # ä¿å­˜é•œåƒåˆ°/mntåˆ†åŒº
          echo "å½“å‰ç¯å¢ƒå˜é‡:"
          env | grep -E "(DOCKER_TMPDIR|TMPDIR|TEMP|TMP)"
          
          echo "Dockerä¸´æ—¶ç›®å½•ç©ºé—´:"
          df -h /mnt/docker_tmp
          
          # å…³é”®ï¼šç›´æ¥ä¿å­˜åˆ°/mntï¼Œé¿å…ä¸´æ—¶æ–‡ä»¶é—®é¢˜
          docker save "$IMAGE_NAME" -o "$WORK_DIR/image.tar" || {
            echo "ç¬¬ä¸€æ¬¡ä¿å­˜å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨ddå‘½ä»¤åˆ†å—ä¿å­˜..."
            # å¤‡é€‰æ–¹æ¡ˆï¼šåˆ†å—ä¿å­˜
            docker create --name temp_container "$IMAGE_NAME"
            CID=$(docker ps -a -f name=temp_container --format "{{.ID}}")
            
            echo "åˆ›å»ºä¸´æ—¶å®¹å™¨: $CID"
            
            # åˆ†å—å¯¼å‡º
            docker export "$CID" | dd of="$WORK_DIR/image.tar" bs=1M
            docker rm -f "$CID"
          }
          
          echo "é•œåƒä¿å­˜å®Œæˆï¼Œæ–‡ä»¶å¤§å°: $(du -h "$WORK_DIR/image.tar")"
          
          # æ£€æŸ¥/mntç©ºé—´
          echo "/mntåˆ†åŒºç©ºé—´ä½¿ç”¨æƒ…å†µ:"
          df -h /mnt
          
          echo "å¼€å§‹åˆ†å‰²æ–‡ä»¶ï¼Œæ¯ç‰‡ $SPLIT_SIZE..."
          cd "$WORK_DIR"
          
          # åˆ†å‰²æ–‡ä»¶
          split -b "$SPLIT_SIZE" -d --additional-suffix=.part "image.tar" "image.tar.part"
          
          echo "åˆ†å‰²å®Œæˆï¼Œåˆ†ç‰‡æ–‡ä»¶åˆ—è¡¨:"
          ls -la image.tar.part*

          echo "éªŒè¯æ¯ä¸ªåˆ†ç‰‡æ–‡ä»¶å¤§å°ï¼ˆç¡®ä¿<2GiBï¼‰..."
          for file in image.tar.part*; do
            FILE_SIZE=$(stat -c%s "$file")
            echo "$file: $FILE_SIZE bytes"
            if [ "$FILE_SIZE" -ge 2147483648 ]; then
              echo "è­¦å‘Š: $file å¤§å°è¶…è¿‡2GiBé™åˆ¶ï¼"
              exit 1
            fi
          done
          
          # ç”Ÿæˆæ ¡éªŒå’Œ
          echo "ç”Ÿæˆæ ¡éªŒå’Œ..."
          sha256sum image.tar.part* > checksums.txt
          sha256sum image.tar >> checksums.txt
          
          # è·å–åˆ†ç‰‡æ•°é‡
          PART_COUNT=$(ls image.tar.part* 2>/dev/null | wc -l)
          echo "åˆ†ç‰‡æ•°é‡: $PART_COUNT"
          
          # åˆ›å»ºè¯´æ˜æ–‡ä»¶
          echo "Docker Image Package" > README.txt
          echo "=====================" >> README.txt
          echo "" >> README.txt
          echo "åŸå§‹é•œåƒ: $IMAGE_NAME" >> README.txt
          echo "åˆ†ç‰‡å¤§å°: $SPLIT_SIZE (ç¡®ä¿å°äº2 GiB = 2048M)" >> README.txt
          echo "åˆ†ç‰‡æ•°é‡: $PART_COUNT" >> README.txt
          echo "å®Œæ•´æ–‡ä»¶å¤§å°: $(du -h image.tar | cut -f1)" >> README.txt
          echo "" >> README.txt
          echo "æ ¡éªŒå’Œæ–‡ä»¶è¯´æ˜:" >> README.txt
          echo "- å‰$PART_COUNTè¡Œæ˜¯å„ä¸ªåˆ†ç‰‡çš„SHA256æ ¡éªŒå’Œ" >> README.txt
          echo "- æœ€åä¸€è¡Œæ˜¯å®Œæ•´image.taræ–‡ä»¶çš„SHA256æ ¡éªŒå’Œ" >> README.txt
          echo "" >> README.txt
          echo "ä½¿ç”¨æ­¥éª¤:" >> README.txt
          echo "1. ä»GitHub releaseä¸‹è½½æ‰€æœ‰æ–‡ä»¶ï¼ˆimage.tar.part*ã€checksums.txtã€README.txtï¼‰" >> README.txt
          echo "2. åœ¨Windowsä¸Šå°†æ‰€æœ‰ä¸‹è½½çš„æ–‡ä»¶æ‰“åŒ…æˆZIPå‹ç¼©åŒ…" >> README.txt
          echo "3. å°†ZIPå‹ç¼©åŒ…ä¸Šä¼ åˆ°LinuxæœåŠ¡å™¨" >> README.txt
          echo "4. åœ¨LinuxæœåŠ¡å™¨ä¸Šæ‰§è¡Œä»¥ä¸‹å‘½ä»¤:" >> README.txt
          echo "" >> README.txt
          echo "# è§£å‹ZIPæ–‡ä»¶" >> README.txt
          echo "unzip package.zip" >> README.txt
          echo "" >> README.txt
          echo "# åˆå¹¶åˆ†ç‰‡æ–‡ä»¶" >> README.txt
          echo "cat image.tar.part* > image.tar" >> README.txt
          echo "" >> README.txt
          echo "# éªŒè¯æ–‡ä»¶å®Œæ•´æ€§" >> README.txt
          echo "sha256sum -c checksums.txt --ignore-missing" >> README.txt
          echo "" >> README.txt
          echo "# å¦‚æœéªŒè¯é€šè¿‡ï¼ŒåŠ è½½Dockeré•œåƒ" >> README.txt
          echo "docker load -i image.tar" >> README.txt
          echo "" >> README.txt
          echo "# æ¸…ç†ä¸´æ—¶æ–‡ä»¶" >> README.txt
          echo "rm image.tar.part* image.tar checksums.txt README.txt" >> README.txt
          echo "" >> README.txt
          echo "æ³¨æ„:" >> README.txt
          echo "- ç¡®ä¿æ‰€æœ‰åˆ†ç‰‡æ–‡ä»¶éƒ½å·²ä¸‹è½½å®Œæ•´" >> README.txt
          echo "- åˆå¹¶é¡ºåºç”±æ–‡ä»¶åæ•°å­—åºå·ä¿è¯ï¼ˆpart00, part01, part02...ï¼‰" >> README.txt
          echo "- å¦‚æœæ ¡éªŒå¤±è´¥ï¼Œè¯·é‡æ–°ä¸‹è½½å¯¹åº”çš„åˆ†ç‰‡æ–‡ä»¶" >> README.txt
          echo "- GitHub releaseæ–‡ä»¶é™åˆ¶ä¸º2 GiBï¼Œå› æ­¤åˆ†ç‰‡å¤§å°è®¾ç½®ä¸º1900M" >> README.txt
          
          # ç§»åŠ¨æ–‡ä»¶åˆ°å·¥ä½œç›®å½•ï¼ˆä½¿ç”¨sudoç¡®ä¿æƒé™ï¼‰
          echo "ç§»åŠ¨æ–‡ä»¶åˆ°å·¥ä½œç›®å½•..."
          echo "ç§»åŠ¨åˆ†ç‰‡æ–‡ä»¶..."
          sudo mv image.tar.part* $GITHUB_WORKSPACE/
          sudo mv checksums.txt $GITHUB_WORKSPACE/
          sudo mv README.txt $GITHUB_WORKSPACE/
          sudo chown $USER:$USER $GITHUB_WORKSPACE/image.tar.part*
          
          echo "ç§»åŠ¨æ ¡éªŒå’Œæ–‡ä»¶..."
          sudo mv checksums.txt $GITHUB_WORKSPACE/
          sudo chown $USER:$USER $GITHUB_WORKSPACE/checksums.txt
          
          echo "ç§»åŠ¨è¯´æ˜æ–‡ä»¶..."
          sudo mv README.txt $GITHUB_WORKSPACE/
          sudo chown $USER:$USER $GITHUB_WORKSPACE/README.txt
          
          echo "å·¥ä½œç›®å½•å†…å®¹:"
          ls -la $GITHUB_WORKSPACE/
          
          # æ¸…ç†/mntä¸Šçš„æ–‡ä»¶
          echo "æ¸…ç†/mntä¸Šçš„ä¸´æ—¶æ–‡ä»¶..."
          sudo rm -f "$WORK_DIR/image.tar"
          
          echo "æ¸…ç†/mntå·¥ä½œç›®å½•..."
          sudo rm -rf "$WORK_DIR"
          sudo rm -rf /mnt/docker_tmp
          
          echo "æ¸…ç†å®Œæˆ"

      - name: Create release with batch uploads
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "å¼€å§‹åˆ›å»ºreleaseå¹¶åˆ†æ‰¹ä¸Šä¼ æ–‡ä»¶..."
          
          RELEASE_TAG="${{ github.event.inputs.release_tag }}${{ github.run_number }}"
          RELEASE_NAME="Docker Image Package ${{ github.event.inputs.image_name }} ($RELEASE_TAG)"
          REPO_FULL_NAME="$GITHUB_REPOSITORY"
          
          echo "åˆ›å»ºrelease: $RELEASE_TAG"
          RELEASE_RESPONSE=$(curl -s -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"tag_name\":\"$RELEASE_TAG\",\"name\":\"$RELEASE_NAME\",\"body\":\"**Dockeré•œåƒåŒ…ä¿¡æ¯**\\n- é•œåƒåç§°: ${{ github.event.inputs.image_name }}\\n- åˆ†ç‰‡å¤§å°: ${{ github.event.inputs.split_size }}M\\n- ç”Ÿæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')\"}" \
            "https://api.github.com/repos/$REPO_FULL_NAME/releases")
          
          RELEASE_ID=$(echo "$RELEASE_RESPONSE" | jq -r '.id')
          UPLOAD_URL=$(echo "$RELEASE_RESPONSE" | jq -r '.upload_url' | cut -d'{' -f1)
          
          echo "Release ID: $RELEASE_ID"
          echo "Upload URL: $UPLOAD_URL"
          
          # åˆ†æ‰¹ä¸Šä¼ æ–‡ä»¶ï¼Œæ¯æ‰¹3ä¸ªæ–‡ä»¶
          PART_FILES=($(ls image.tar.part* 2>/dev/null))
          CHECKSUM_FILE="checksums.txt"
          README_FILE="README.txt"
          
          echo "éœ€è¦ä¸Šä¼ çš„æ–‡ä»¶åˆ—è¡¨:"
          echo "åˆ†ç‰‡æ–‡ä»¶: ${PART_FILES[@]}"
          echo "æ ¡éªŒå’Œæ–‡ä»¶: $CHECKSUM_FILE"
          echo "è¯´æ˜æ–‡ä»¶: $README_FILE"
          
          echo "åˆ†æ‰¹ä¸Šä¼ åˆ†ç‰‡æ–‡ä»¶ï¼ˆæ¯æ‰¹3ä¸ªï¼‰..."
          BATCH_SIZE=3
          for ((i=0; i<${#PART_FILES[@]}; i+=BATCH_SIZE)); do
            echo "ä¸Šä¼ æ‰¹æ¬¡ $(($i/$BATCH_SIZE + 1)): æ–‡ä»¶ ${PART_FILES[@]:$i:$BATCH_SIZE}"
            
            for file in "${PART_FILES[@]:$i:$BATCH_SIZE}"; do
              FILENAME=$(basename "$file")
              echo "â¬†ï¸ ä¸Šä¼  $FILENAME (å°è¯•1)..."
              
              # å¸¦é‡è¯•æœºåˆ¶çš„ä¸Šä¼ 
              MAX_RETRIES=3
              RETRY_COUNT=0
              SUCCESS=false
              
              while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
                RESPONSE=$(curl -s -X POST \
                  -H "Authorization: token $GITHUB_TOKEN" \
                  -H "Content-Type: application/octet-stream" \
                  --data-binary @"$file" \
                  "$UPLOAD_URL?name=$FILENAME")
                
                if echo "$RESPONSE" | jq -e '.id' >/dev/null 2>&1; then
                  echo "âœ… $FILENAME ä¸Šä¼ æˆåŠŸ"
                  SUCCESS=true
                  break
                else
                  RETRY_COUNT=$((RETRY_COUNT + 1))
                  echo "âŒ $FILENAME ä¸Šä¼ å¤±è´¥ (å°è¯• $RETRY_COUNT/$MAX_RETRIES)"
                  echo "é”™è¯¯ä¿¡æ¯: $(echo "$RESPONSE" | jq -r '.message // .error // "æœªçŸ¥é”™è¯¯"')"
                  
                  if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                    echo "ç­‰å¾…5ç§’åé‡è¯•..."
                    sleep 5
                  fi
                fi
              done
              
              if [ "$SUCCESS" = "false" ]; then
                echo "âŒ $FILENAME ä¸Šä¼ å¤±è´¥ï¼Œå·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°"
                exit 1
              fi
            done
            
            echo "æ‰¹æ¬¡ $(($i/$BATCH_SIZE + 1)) ä¸Šä¼ å®Œæˆï¼Œç­‰å¾…10ç§’..."
            sleep 10
          done
          
          echo "ä¸Šä¼ æ ¡éªŒå’Œæ–‡ä»¶å’Œè¯´æ˜æ–‡ä»¶..."
          for file in "$CHECKSUM_FILE" "$README_FILE"; do
            FILENAME=$(basename "$file")
            echo "â¬†ï¸ ä¸Šä¼  $FILENAME..."
            
            MAX_RETRIES=3
            RETRY_COUNT=0
            SUCCESS=false
            
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              RESPONSE=$(curl -s -X POST \
                -H "Authorization: token $GITHUB_TOKEN" \
                -H "Content-Type: application/octet-stream" \
                --data-binary @"$file" \
                "$UPLOAD_URL?name=$FILENAME")
              
              if echo "$RESPONSE" | jq -e '.id' >/dev/null 2>&1; then
                echo "âœ… $FILENAME ä¸Šä¼ æˆåŠŸ"
                SUCCESS=true
                break
              else
                RETRY_COUNT=$((RETRY_COUNT + 1))
                echo "âŒ $FILENAME ä¸Šä¼ å¤±è´¥ (å°è¯• $RETRY_COUNT/$MAX_RETRIES)"
                echo "é”™è¯¯ä¿¡æ¯: $(echo "$RESPONSE" | jq -r '.message // .error // "æœªçŸ¥é”™è¯¯"')"
                
                if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                  echo "ç­‰å¾…5ç§’åé‡è¯•..."
                  sleep 5
                fi
              fi
            done
            
            if [ "$SUCCESS" = "false" ]; then
              echo "âŒ $FILENAME ä¸Šä¼ å¤±è´¥ï¼Œå·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°"
              exit 1
            fi
          done
          
          echo "ğŸ‰ æ‰€æœ‰æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼"
          echo "Release URL: https://github.com/$REPO_FULL_NAME/releases/tag/$RELEASE_TAG"

      - name: Final cleanup
        if: always()
        run: |
          echo "æœ€ç»ˆæ¸…ç†..."
          # åªæ¸…ç†æˆ‘ä»¬åˆ›å»ºçš„æ–‡ä»¶
          rm -f image.tar.part* 2>/dev/null || true
          rm -f checksums.txt 2>/dev/null || true
          rm -f README.txt 2>/dev/null || true
          
          # æ¸…ç†/mntä¸Šçš„æ®‹ç•™æ–‡ä»¶
          sudo rm -rf /mnt/docker_image_package_* 2>/dev/null || true
          sudo rm -rf /mnt/docker_tmp 2>/dev/null || true
          
          # æ¸…ç†dockerç³»ç»Ÿ
          sudo docker system prune -a -f --volumes
          
          # å†æ¬¡æ£€æŸ¥ç©ºé—´
          echo "æœ€ç»ˆç£ç›˜ç©ºé—´:"
          df -h /mnt
          df -h /
          
          echo "æ¸…ç†å®Œæˆ"
